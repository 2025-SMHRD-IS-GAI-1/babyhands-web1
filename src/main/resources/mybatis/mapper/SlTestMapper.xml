<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.babyhands.dao.SlTestDAO">

	<!-- 마이페이지 : 누적 점수, 랭킹 가져오기 -->
	<select id="getScoreRank" parameterType="string"
		resultType="com.babyhands.dto.MemberScoreRank">
		SELECT *
		FROM (
		SELECT
		sub.MEMBER_ID AS memberId,
		NVL(sub.totalScore, 0) AS totalScore,
		DENSE_RANK() OVER (ORDER BY
		NVL(sub.totalScore, 0) DESC) AS rankNo
		FROM (
		SELECT
		m.MEMBER_ID,
		COUNT(t.SL_ID) * 10 AS totalScore
		FROM MEMBER m
		LEFT OUTER JOIN SL_TEST
		t
		ON m.MEMBER_ID = t.MEMBER_ID
		AND t.CHOOSE_ANSWER IN (
		SELECT s.MEANING
		FROM SIGN_LANGUAGE s
		WHERE s.SL_ID = t.SL_ID
		)
		GROUP BY m.MEMBER_ID
		) sub
		)
		WHERE ROWNUM &lt;= 1
	</select>

	<!-- 내 점수/순위 (이메일) : 아직 문제 안 푼 회원도 0점 나오게 하려면 LEFT OUTER JOIN 버전 권장 -->
	<select id="getScoreRankByEmail" parameterType="string"
		resultType="com.babyhands.dto.MemberScoreRank">
		SELECT memberId, totalScore, rankNo
		FROM (
		SELECT
		sub.memberId,
		sub.totalScore,
		DENSE_RANK() OVER(ORDER BY sub.totalScore
		DESC) AS rankNo
		FROM (
		SELECT
		m.MEMBER_ID AS memberId,
		NVL(COUNT(t.SL_ID), 0) * 10 AS totalScore
		FROM MEMBER m
		LEFT OUTER JOIN
		SL_TEST t
		ON m.MEMBER_ID = t.MEMBER_ID
		AND t.CHOOSE_ANSWER IN (
		SELECT
		s.MEANING FROM SIGN_LANGUAGE s WHERE s.SL_ID = t.SL_ID
		)
		GROUP BY
		m.MEMBER_ID
		) sub
		)
		WHERE memberId = (SELECT MEMBER_ID FROM MEMBER WHERE
		EMAIL = #{email})
	</select>

	<!-- 수어 학습 테스트 : 입력 전 group 가져오기 -->
	<select id="getGroup" resultType="int">
		SELECT MAX(SL_TEST_GROUP) + 1
		from SL_TEST
	</select>

	<insert id="insert" parameterType="com.babyhands.vo.SlTestVO">
		INSERT INTO
		SL_TEST(SL_TEST_DATE, SL_TEST_GROUP, CHOOSE_ANSWER, MEMBER_ID, SL_ID)
		VALUES(SYSDATE, #{slTestGroup}, #{chooseAnswer}, #{memberId}, #{slId})
	</insert>
	
	<!-- TOP N -->
	<select id="selectRankingTopN" parameterType="int"
		resultType="com.babyhands.dto.MemberScoreRank">
		SELECT memberId, totalScore, rankNo
		FROM (
		SELECT
		m.MEMBER_ID
		AS memberId,
		NVL(COUNT(s.SL_ID),0) * 10 AS totalScore,
		DENSE_RANK() OVER
		(ORDER BY NVL(COUNT(s.SL_ID),0) * 10 DESC) AS rankNo
		FROM MEMBER m
		LEFT
		JOIN SL_TEST t ON m.MEMBER_ID = t.MEMBER_ID
		LEFT JOIN SIGN_LANGUAGE s
		ON t.SL_ID = s.SL_ID AND t.CHOOSE_ANSWER = s.MEANING
		GROUP BY
		m.MEMBER_ID
		)
		WHERE rankNo &lt;= #{value}
		ORDER BY rankNo, totalScore
		DESC, memberId
	</select>

</mapper> 