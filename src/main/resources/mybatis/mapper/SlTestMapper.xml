<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.babyhands.dao.SlTestDAO">

	<!-- 마이페이지 : 누적 점수, 랭킹 가져오기 -->
<select id="getScoreRank" parameterType="string"
        resultType="com.babyhands.dto.MemberScoreRank">

  	SELECT memberId, nickname, totalScore, rankNo
  	FROM (
    	SELECT
      		m.MEMBER_ID AS memberId,
      		m.NICKNAME  AS nickname,
      		COUNT(s.SL_ID) * 10 AS totalScore,
      		DENSE_RANK() OVER (ORDER BY COUNT(s.SL_ID) * 10 DESC) AS rankNo
    	FROM MEMBER m
    		LEFT JOIN SL_TEST t ON m.MEMBER_ID = t.MEMBER_ID
    		LEFT JOIN SIGN_LANGUAGE s ON t.SL_ID = s.SL_ID 
    		AND t.CHOOSE_ANSWER = s.MEANING
    		GROUP BY m.MEMBER_ID, m.NICKNAME
  	)
  	WHERE memberId = #{memberId}            <!--  단일 파라미터면 #{value} 또는 #{_parameter} -->
	</select>


	<!-- 내 점수/순위 (이메일) : 아직 문제 안 푼 회원도 0점 나오게 하려면 LEFT OUTER JOIN 버전 권장 -->
	<select id="getScoreRankByEmail" parameterType="string"
		resultType="com.babyhands.dto.MemberScoreRank">
		SELECT memberId, totalScore, rankNo
		FROM (
		SELECT
		sub.memberId,
		sub.totalScore,
		DENSE_RANK() OVER(ORDER BY sub.totalScore
		DESC) AS rankNo
		FROM (
		SELECT
		m.MEMBER_ID AS memberId,
		NVL(COUNT(t.SL_ID), 0) * 10 AS totalScore
		FROM MEMBER m
		LEFT OUTER JOIN
		SL_TEST t
		ON m.MEMBER_ID = t.MEMBER_ID
		AND t.CHOOSE_ANSWER IN (
		SELECT
		s.MEANING FROM SIGN_LANGUAGE s WHERE s.SL_ID = t.SL_ID
		)
		GROUP BY
		m.MEMBER_ID
		) sub
		)
		WHERE memberId = (SELECT MEMBER_ID FROM MEMBER WHERE
		EMAIL = #{email})
	</select>

	<!-- 수어 학습 테스트 : 입력 전 group 가져오기 -->
	<select id="getGroup" resultType="int">
		SELECT NVL(MAX(SL_TEST_GROUP) + 1, 1)
		FROM SL_TEST
	</select>

	<insert id="insert" parameterType="com.babyhands.vo.SlTestVO">
		INSERT INTO
		SL_TEST(SL_TEST_DATE, SL_TEST_GROUP, CHOOSE_ANSWER, MEMBER_ID, SL_ID)
		VALUES(#{slTestDate}, #{slTestGroup}, #{chooseAnswer}, #{memberId}, #{slId})
	</insert>




	<!-- TOP N -->
<!-- /////////////////////////////////////////////////////////////// -->

<!-- 랭킹에 포함될 전체 인원 -->
<select id="countAllRanking" resultType="int">
  SELECT COUNT(*)
    FROM (
      SELECT m.MEMBER_ID
        FROM MEMBER m
        LEFT JOIN SL_TEST t ON m.MEMBER_ID = t.MEMBER_ID
        LEFT JOIN SIGN_LANGUAGE s
               ON t.SL_ID = s.SL_ID
              AND t.CHOOSE_ANSWER = s.MEANING
       GROUP BY m.MEMBER_ID
    )
</select>

<!-- 무한스크롤?? -->
<select id="selectRankingSlice" parameterType="map"
        resultType="com.babyhands.dto.MemberScoreRank">
  SELECT *
  FROM (
    SELECT t.*, ROWNUM rn
    FROM (
      SELECT
        memberId,
        nickname,
        totalScore,
        rankNo
      FROM (
        SELECT
          m.MEMBER_ID AS memberId,
          m.NICKNAME  AS nickname,
          COUNT(s.SL_ID) * 10 AS totalScore,
          DENSE_RANK() OVER (ORDER BY COUNT(s.SL_ID) * 10 DESC) AS rankNo
        FROM MEMBER m
        LEFT JOIN SL_TEST t
               ON m.MEMBER_ID = t.MEMBER_ID
        LEFT JOIN SIGN_LANGUAGE s
               ON t.SL_ID = s.SL_ID
              AND t.CHOOSE_ANSWER = s.MEANING
        GROUP BY m.MEMBER_ID, m.NICKNAME
      )
      ORDER BY rankNo, totalScore DESC, memberId
    ) t
    WHERE ROWNUM &lt;= #{offset} + #{limit}
  )
  WHERE rn &gt; #{offset}
</select>



<!-- /////////////////////////////////////////////////////////////// -->




	 <!-- 1) 해당 회원의 '최신 응시 그룹' 번호 (없으면 0) -->
  <select id="selectLatestGroup" parameterType="string" resultType="int">
    SELECT NVL(MAX(SL_TEST_GROUP), 0)
    FROM SL_TEST
    WHERE MEMBER_ID = #{memberId}
  </select>

  <!-- 2) 최신 그룹의 문항별 결과 (내답/정답/정오) -->
  <select id="selectQuestionResultsByGroup"
          parameterType="map"
          resultType="com.babyhands.dto.SignQuestionResult">
    SELECT
      t.SL_ID                 AS slId,
      t.CHOOSE_ANSWER         AS jamo,         -- 내가 고른 답
      s.MEANING               AS correctJamo,  -- 정답
      CASE WHEN s.MEANING = t.CHOOSE_ANSWER THEN 1 ELSE 0 END AS isCorrect
    FROM SL_TEST t
    JOIN SIGN_LANGUAGE s ON s.SL_ID = t.SL_ID
    WHERE t.MEMBER_ID = #{memberId}
      AND t.SL_TEST_GROUP = #{groupNo}
    ORDER BY t.SL_TEST_DATE
  </select>

  <!-- 3) 최신 그룹 요약 (정답 수 / 총 문항 / 총 점수) -->
  <select id="selectSummaryByGroup"
          parameterType="map"
          resultType="com.babyhands.dto.SignTestSummary">
    SELECT
      SUM(CASE WHEN s.MEANING = t.CHOOSE_ANSWER THEN 1 ELSE 0 END) AS correctCount,
      COUNT(*)                                                     AS totalCount,
      SUM(CASE WHEN s.MEANING = t.CHOOSE_ANSWER THEN 1 ELSE 0 END) * 10 AS totalScore
    FROM SL_TEST t
    JOIN SIGN_LANGUAGE s ON s.SL_ID = t.SL_ID
    WHERE t.MEMBER_ID = #{memberId}
      AND t.SL_TEST_GROUP = #{groupNo}
  </select>
	
	<!-- 지난 학습결과 : 총 학습일 수 가져오기 -->
	<select id="getTotalTestDay" parameterType="string" resultType="int">
		<![CDATA[
			SELECT COUNT(DISTINCT(TRUNC(SL_TEST_DATE)))
			FROM SL_TEST
			WHERE MEMBER_ID = #{memberId}
		]]>
	</select>
	
	<!-- 지난 학습 결과 : 평균 값 가져오기 -->
	<select id="getAvgScore" parameterType="string" resultType="int">
	  SELECT NVL(ROUND(AVG(sub.correct_cnt * 10)), 0) AS avg_score
	  FROM (
	    SELECT t.sl_test_group,
	           COUNT(*) AS correct_cnt
	    FROM sl_test t
	    JOIN sign_language l ON t.sl_id = l.sl_id
	    WHERE t.member_id = #{memberId}
	      AND t.choose_answer = l.meaning
	    GROUP BY t.sl_test_group
	  ) sub
	</select>
	
	<!-- 지난 학습 결과 : 지난 학습 목록 리스트 가져오기 -->
	<select id="getLastTestList" parameterType="string" resultType="com.babyhands.dto.LastTestDTO">
		SELECT DISTINCT
			SUB.SL_TEST_GROUP,
			SUB.CORRECT,
			T.SL_TEST_DATE
		FROM (
			SELECT SL_TEST_GROUP,
            SUM(CASE WHEN T.CHOOSE_ANSWER = L.MEANING THEN 1 ELSE 0 END) AS CORRECT
            FROM SL_TEST T
            LEFT JOIN SIGN_LANGUAGE L ON T.SL_ID = L.SL_ID
            WHERE MEMBER_ID = #{memberId}
            GROUP BY SL_TEST_GROUP
		) SUB, 
		SL_TEST T
		WHERE SUB.SL_TEST_GROUP = T.SL_TEST_GROUP
		ORDER BY T.SL_TEST_DATE DESC
	</select>
	
	<!-- 지난 학습 결과 : 지난 일주일 일일 학습량 리스트 가져오기 -->
	<select id="dailyTestList" parameterType="string" resultType="com.babyhands.dto.DailyTestDTO">
	<![CDATA[
		WITH days AS (
		  SELECT TRUNC(SYSDATE) - 6 + LEVEL - 1 AS dt
		  FROM dual
		  CONNECT BY LEVEL <= 7
		),
		agg AS (
		  SELECT TRUNC(t.sl_test_date) AS dt,
		         COUNT(*)              AS cnt
		  FROM sl_test t
		  WHERE t.sl_test_date >= TRUNC(SYSDATE) - 6
		    AND t.sl_test_date <  TRUNC(SYSDATE) + 1
		    AND t.member_id = #{memberId}
		  GROUP BY TRUNC(t.sl_test_date)
		)
		SELECT TO_CHAR(d.dt, 'DY', 'NLS_DATE_LANGUAGE=KOREAN') AS day,
		       NVL(a.cnt, 0) AS testCount
		FROM days d
		LEFT JOIN agg a ON a.dt = d.dt
		ORDER BY d.dt
	]]>
	</select>

</mapper> 