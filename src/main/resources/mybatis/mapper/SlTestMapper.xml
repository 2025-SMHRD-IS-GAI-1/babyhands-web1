<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.babyhands.dao.SlTestDAO">

	<!-- 마이페이지 : 누적 점수, 랭킹 가져오기 -->
	<select id="getScoreRank" parameterType="string"
		resultType="com.babyhands.dto.MemberScoreRank">
		SELECT *
		FROM (
		    SELECT 
		        T.MEMBER_ID AS memberId,
		        COUNT(T.SL_ID) * 10 AS totalScore,
		        DENSE_RANK() OVER (ORDER BY COUNT(T.SL_ID) * 10 DESC) AS rankNo
		    FROM SL_TEST T
		    LEFT JOIN MEMBER M
		        ON T.MEMBER_ID = M.MEMBER_ID
		    INNER JOIN SIGN_LANGUAGE S
		        ON T.SL_ID = S.SL_ID
		        AND T.CHOOSE_ANSWER = S.MEANING
		    GROUP BY T.MEMBER_ID
		) S
		WHERE S.memberId = #{memberId}
	</select>

	<!-- 내 점수/순위 (이메일) : 아직 문제 안 푼 회원도 0점 나오게 하려면 LEFT OUTER JOIN 버전 권장 -->
	<select id="getScoreRankByEmail" parameterType="string"
		resultType="com.babyhands.dto.MemberScoreRank">
		SELECT memberId, totalScore, rankNo
		FROM (
		SELECT
		sub.memberId,
		sub.totalScore,
		DENSE_RANK() OVER(ORDER BY sub.totalScore
		DESC) AS rankNo
		FROM (
		SELECT
		m.MEMBER_ID AS memberId,
		NVL(COUNT(t.SL_ID), 0) * 10 AS totalScore
		FROM MEMBER m
		LEFT OUTER JOIN
		SL_TEST t
		ON m.MEMBER_ID = t.MEMBER_ID
		AND t.CHOOSE_ANSWER IN (
		SELECT
		s.MEANING FROM SIGN_LANGUAGE s WHERE s.SL_ID = t.SL_ID
		)
		GROUP BY
		m.MEMBER_ID
		) sub
		)
		WHERE memberId = (SELECT MEMBER_ID FROM MEMBER WHERE
		EMAIL = #{email})
	</select>

	<!-- 수어 학습 테스트 : 입력 전 group 가져오기 -->
	<select id="getGroup" resultType="int">
		SELECT MAX(SL_TEST_GROUP) + 1
		from SL_TEST
	</select>

	<insert id="insert" parameterType="com.babyhands.vo.SlTestVO">
		INSERT INTO
		SL_TEST(SL_TEST_DATE, SL_TEST_GROUP, CHOOSE_ANSWER, MEMBER_ID, SL_ID)
		VALUES(SYSDATE, #{slTestGroup}, #{chooseAnswer}, #{memberId}, #{slId})
	</insert>

	<!-- TOP N -->
	<select id="selectRankingTopN" parameterType="int"
		resultType="com.babyhands.dto.MemberScoreRank">
		SELECT memberId, totalScore, rankNo
		FROM (
		SELECT
		m.MEMBER_ID
		AS memberId,
		NVL(COUNT(s.SL_ID),0) * 10 AS totalScore,
		DENSE_RANK() OVER
		(ORDER BY NVL(COUNT(s.SL_ID),0) * 10 DESC) AS rankNo
		FROM MEMBER m
		LEFT
		JOIN SL_TEST t ON m.MEMBER_ID = t.MEMBER_ID
		LEFT JOIN SIGN_LANGUAGE s
		ON t.SL_ID = s.SL_ID AND t.CHOOSE_ANSWER = s.MEANING
		GROUP BY
		m.MEMBER_ID
		)
		WHERE rankNo &lt;= #{value}
		ORDER BY rankNo, totalScore
		DESC, memberId
	</select>

<!-- =========================
       수어 테스트 결과 저장/조회
       VO: com.babyhands.vo.SlTestVO
       테이블: SL_TEST (아래 컬럼 존재 가정)
       SL_TEST_ID, MEMBER_ID, TOTAL_QUESTIONS, CORRECT_COUNT, SCORE, ELAPSED_SEC, CREATED_AT
       ========================= -->

  <!-- 결과 저장 -->
  <insert id="insertSignTestResult"
          parameterType="com.babyhands.vo.SlTestVO"
          useGeneratedKeys="true" keyProperty="slTestId">
    INSERT INTO SL_TEST (
      SL_TEST_ID, MEMBER_ID, TOTAL_QUESTIONS, CORRECT_COUNT, SCORE, ELAPSED_SEC, CREATED_AT
    ) VALUES (
      SL_TEST_SEQ.NEXTVAL, #{memberId}, #{totalQuestions}, #{correctCount}, #{score}, #{elapsedSec}, SYSTIMESTAMP
    )
  </insert>

  <!-- 최신 결과(회원별 1건) -->
  <select id="selectLatestResultByMember"
          parameterType="string"
          resultType="com.babyhands.vo.SlTestVO">
    SELECT
      t.SL_TEST_ID      AS slTestId,
      t.MEMBER_ID       AS memberId,
      t.TOTAL_QUESTIONS AS totalQuestions,
      t.CORRECT_COUNT   AS correctCount,
      t.SCORE           AS score,
      t.ELAPSED_SEC     AS elapsedSec,
      CAST(t.CREATED_AT AS TIMESTAMP) AS createdAt
    FROM SL_TEST t
    WHERE t.MEMBER_ID = #{memberId}
    ORDER BY t.CREATED_AT DESC
    FETCH FIRST 1 ROWS ONLY
  </select>

  <!-- 정확도/랭킹 포함 요약 -->
  <select id="selectResultSummary"
          parameterType="string"
          resultType="com.babyhands.vo.SlTestVO">
    WITH latest AS (
      SELECT
        t.SL_TEST_ID      AS slTestId,
        t.MEMBER_ID       AS memberId,
        t.TOTAL_QUESTIONS AS totalQuestions,
        t.CORRECT_COUNT   AS correctCount,
        t.SCORE           AS score,
        t.ELAPSED_SEC     AS elapsedSec,
        t.CREATED_AT      AS createdAt
      FROM SL_TEST t
      WHERE t.MEMBER_ID = #{memberId}
      ORDER BY t.CREATED_AT DESC
      FETCH FIRST 1 ROWS ONLY
    ),
    ranks AS (
      SELECT
        MEMBER_ID,
        NVL(SUM(SCORE),0) AS totalScore,
        DENSE_RANK() OVER (ORDER BY NVL(SUM(SCORE),0) DESC) AS rankNo
      FROM SL_TEST
      GROUP BY MEMBER_ID
    )
    SELECT
      l.slTestId,
      l.memberId,
      l.totalQuestions,
      l.correctCount,
      l.score,
      l.elapsedSec,
      CAST(l.createdAt AS TIMESTAMP) AS createdAt,
      CASE WHEN l.totalQuestions = 0 THEN 0
           ELSE ROUND(l.correctCount * 100.0 / l.totalQuestions, 1)
      END AS accuracy,
      (SELECT r.rankNo FROM ranks r WHERE r.MEMBER_ID = l.memberId) AS rankNo
    FROM latest l
  </select>
</mapper> 