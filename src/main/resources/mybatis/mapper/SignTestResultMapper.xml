<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.babyhands.dao.SlTestResultDAO">

  <!-- 결과 저장 -->
  <!-- 오라클은 useGeneratedKeys 잘 안됨: 시퀀스 + selectKey로 ID 세팅 -->
<insert id="insertSignTestResult" parameterType="com.babyhands.vo.SlTestResultVO">
  <selectKey keyProperty="slTestId" resultType="long" order="BEFORE">
    SELECT SL_TEST_SEQ.NEXTVAL FROM DUAL
  </selectKey>

  INSERT INTO SL_TEST (
    SL_TEST_ID, MEMBER_ID, TOTAL_QUESTIONS, CORRECT_COUNT, SCORE, ELAPSED_SEC, CREATED_AT
  ) VALUES (
    #{slTestId,       jdbcType=NUMERIC},
    #{memberId,       jdbcType=VARCHAR},
    #{totalQuestions, jdbcType=NUMERIC},
    #{correctCount,   jdbcType=NUMERIC},
    #{score,          jdbcType=NUMERIC},
    #{elapsedSec,     jdbcType=NUMERIC},
    SYSTIMESTAMP
  )
</insert>

  <!-- 최신 결과(회원별 1건) -->
  <!-- 단일 파라미터(String)로 호출한다면 #{value}를 써야 안전 -->
<select id="selectLatestResultByMember"
        parameterType="string"
        resultType="com.babyhands.vo.SlTestResultVO">
  SELECT
    x.SL_TEST_ID      AS slTestId,
    x.MEMBER_ID       AS memberId,
    x.TOTAL_QUESTIONS AS totalQuestions,
    x.CORRECT_COUNT   AS correctCount,
    x.SCORE           AS score,
    x.ELAPSED_SEC     AS elapsedSec,
    CAST(x.CREATED_AT AS TIMESTAMP) AS createdAt
  FROM (
    SELECT
      t.SL_TEST_ID,
      t.MEMBER_ID,
      t.TOTAL_QUESTIONS,
      t.CORRECT_COUNT,
      t.SCORE,
      t.ELAPSED_SEC,
      t.CREATED_AT,
      ROW_NUMBER() OVER (PARTITION BY t.MEMBER_ID ORDER BY t.CREATED_AT DESC) AS rn
    FROM SL_TEST t
    WHERE t.MEMBER_ID = #{value}
  ) x
  WHERE x.rn = 1
</select>

  <!-- 정확도/랭킹 포함 요약 -->
<select id="selectResultSummary"
        parameterType="string"
        resultType="com.babyhands.vo.SlTestResultVO">
  WITH latest AS (
    SELECT
      t.SL_TEST_ID      AS slTestId,
      t.MEMBER_ID       AS memberId,
      t.TOTAL_QUESTIONS AS totalQuestions,
      t.CORRECT_COUNT   AS correctCount,
      t.SCORE           AS score,
      t.ELAPSED_SEC     AS elapsedSec,
      t.CREATED_AT      AS createdAt
    FROM (
      SELECT
        t.*,
        ROW_NUMBER() OVER (PARTITION BY t.MEMBER_ID ORDER BY t.CREATED_AT DESC) rn
      FROM SL_TEST t
      WHERE t.MEMBER_ID = #{value}
    ) t
    WHERE t.rn = 1
  ),
  ranks AS (
    SELECT
      MEMBER_ID,
      NVL(SUM(SCORE),0) AS totalScore,
      DENSE_RANK() OVER (ORDER BY NVL(SUM(SCORE),0) DESC) AS rankNo
    FROM SL_TEST
    GROUP BY MEMBER_ID
  )
  SELECT
    l.slTestId,
    l.memberId,
    l.totalQuestions,
    l.correctCount,
    l.score,
    l.elapsedSec,
    CAST(l.createdAt AS TIMESTAMP) AS createdAt,
    CASE WHEN l.totalQuestions = 0 THEN 0
         ELSE ROUND(l.correctCount * 100.0 / l.totalQuestions, 1)
    END AS accuracy,
    (SELECT r.rankNo FROM ranks r WHERE r.MEMBER_ID = l.memberId) AS rankNo
  FROM latest l
</select>

</mapper>
