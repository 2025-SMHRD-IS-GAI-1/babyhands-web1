<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- DAO 네임스페이스와 100% 일치! -->
<mapper namespace="com.babyhands.dao.SlTestResultDAO">

  <!-- 결과 저장 -->
  <insert id="insertSignTestResult"
          parameterType="com.babyhands.vo.SlTestResultVO"
          useGeneratedKeys="true" keyProperty="slTestId">
    INSERT INTO SL_TEST (
      SL_TEST_ID, MEMBER_ID, TOTAL_QUESTIONS, CORRECT_COUNT, SCORE, ELAPSED_SEC, CREATED_AT
    ) VALUES (
      SL_TEST_SEQ.NEXTVAL, #{memberId}, #{totalQuestions}, #{correctCount},
      #{score}, #{elapsedSec}, SYSTIMESTAMP
    )
  </insert>

  <!-- 최신 결과(회원별 1건) -->
  <select id="selectLatestResultByMember"
          parameterType="string"
          resultType="com.babyhands.vo.SlTestResultVO">
    SELECT
      t.SL_TEST_ID      AS slTestId,
      t.MEMBER_ID       AS memberId,
      t.TOTAL_QUESTIONS AS totalQuestions,
      t.CORRECT_COUNT   AS correctCount,
      t.SCORE           AS score,
      t.ELAPSED_SEC     AS elapsedSec,
      CAST(t.CREATED_AT AS TIMESTAMP) AS createdAt
    FROM SL_TEST t
    WHERE t.MEMBER_ID = #{memberId}
    ORDER BY t.CREATED_AT DESC
    FETCH FIRST 1 ROWS ONLY
  </select>

  <!-- 정확도/랭킹 포함 요약 -->
  <select id="selectResultSummary"
          parameterType="string"
          resultType="com.babyhands.vo.SlTestResultVO">
    WITH latest AS (
      SELECT
        t.SL_TEST_ID      AS slTestId,
        t.MEMBER_ID       AS memberId,
        t.TOTAL_QUESTIONS AS totalQuestions,
        t.CORRECT_COUNT   AS correctCount,
        t.SCORE           AS score,
        t.ELAPSED_SEC     AS elapsedSec,
        t.CREATED_AT      AS createdAt
      FROM SL_TEST t
      WHERE t.MEMBER_ID = #{memberId}
      ORDER BY CREATED_AT DESC
      FETCH FIRST 1 ROWS ONLY
    ),
    ranks AS (
      SELECT
        MEMBER_ID,
        NVL(SUM(SCORE),0) AS totalScore,
        DENSE_RANK() OVER (ORDER BY NVL(SUM(SCORE),0) DESC) AS rankNo
      FROM SL_TEST
      GROUP BY MEMBER_ID
    )
    SELECT
      l.slTestId,
      l.memberId,
      l.totalQuestions,
      l.correctCount,
      l.score,
      l.elapsedSec,
      CAST(l.createdAt AS TIMESTAMP) AS createdAt,
      CASE WHEN l.totalQuestions = 0 THEN 0
           ELSE ROUND(l.correctCount * 100.0 / l.totalQuestions, 1)
      END AS accuracy,
      (SELECT r.rankNo FROM ranks r WHERE r.MEMBER_ID = l.memberId) AS rankNo
    FROM latest l
  </select>

</mapper>